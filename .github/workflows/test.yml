name: Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "22"
          cache: "yarn"

      - name: Install dependencies
        run: yarn install --immutable

      - name: Run linter
        run: yarn lint

      - name: Run unit tests
        run: yarn test

      - name: Build
        run: yarn build

      - name: Check build output
        run: |
          echo "Checking build output..."
          du -sh build/assets/*.js | sort -h
          echo ""
          echo "Total build size:"
          du -sh build
          echo ""
          echo "Build completed successfully"

  lighthouse:
    name: Lighthouse Audits
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "22"
          cache: "yarn"

      - name: Install dependencies
        run: yarn install --immutable

      - name: Build production site
        run: yarn build

      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v12
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
        with:
          urls: |
            http://localhost:4173
          configPath: "./.lighthouserc.desktop.json"
          uploadArtifacts: true
          temporaryPublicStorage: true

      - name: Print Lighthouse scores summary
        if: always()
        run: node scripts/print-lighthouse-scores.mjs

  deploy:
    name: Production Deployment
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      deployments: write
      contents: read

    steps:
      - name: Start deployment
        id: deployment
        uses: actions/github-script@v7
        with:
          script: |
            const deployment = await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.sha,
              environment: 'production',
              required_contexts: [],
              auto_merge: false,
              description: 'Deploy to Cloudflare Pages'
            });

            return deployment.data.id;

      - name: Wait for Cloudflare deployment
        run: |
          echo "â³ Waiting for Cloudflare Pages deployment to complete..."
          echo "Cloudflare is automatically deploying from main branch"
          sleep 30

      - name: Update deployment status
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: ${{ steps.deployment.outputs.result }},
              state: 'success',
              environment_url: 'https://nickhs.dev',
              description: 'Deployment completed successfully',
              auto_inactive: true
            });

      - name: Create deployment summary
        run: |
          echo "## ðŸš€ Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Your site has been deployed to production!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŒ Live Site" >> $GITHUB_STEP_SUMMARY
          echo "**[https://nickhs.dev](https://nickhs.dev)** âœ¨" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Deployment Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: Production" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: [\`${GITHUB_SHA:0:7}\`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployed by**: Cloudflare Pages" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployment ID**: \`${{ steps.deployment.outputs.result }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ’¡ View deployment history in the [Environments](https://github.com/${{ github.repository }}/deployments) tab" >> $GITHUB_STEP_SUMMARY
